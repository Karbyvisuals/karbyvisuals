<!-- … celý HTML + CSS BEZE ZMĚN … -->

<script>
/* CANVAS BACKGROUND */
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let particles = [];
const mouse = { x: null, y: null };

function initCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

class Particle {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 1.5 + 0.5;
    this.baseX = this.x;
    this.baseY = this.y;
    this.density = (Math.random() * 30) + 1;
  }
  draw() {
    ctx.fillStyle = 'rgba(255, 122, 24, 0.4)';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
  update() {
    if (mouse.x === null || mouse.y === null) return; // FIX
    let dx = mouse.x - this.x;
    let dy = mouse.y - this.y;
    let distance = Math.sqrt(dx*dx + dy*dy) || 1; // FIX

    if (distance < 100) {
      this.x -= (dx/distance) * (100-distance)/100 * this.density;
      this.y -= (dy/distance) * (100-distance)/100 * this.density;
    } else {
      this.x += (this.baseX - this.x) / 10;
      this.y += (this.baseY - this.y) / 10;
    }
  }
}

function initParticles() {
  particles = [];
  for (let i = 0; i < (canvas.width * canvas.height) / 9000; i++) {
    particles.push(new Particle());
  }
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => { p.draw(); p.update(); });
  requestAnimationFrame(animate);
}

window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
window.addEventListener('resize', () => { initCanvas(); initParticles(); });

initCanvas();
initParticles();
animate();

/* … TRANSLATIONS BEZE ZMĚN … */

/* MINI GAME LOGIC */
const CHANCES = [{val:10, w:60}, {val:15, w:25}, {val:25, w:14}, {val:100, w:1}];

function openBox() {
  const box = document.getElementById('loot-box');
  if (!box || box.classList.contains('open')) return; // FIX

  box.classList.add('open');

  let rand = Math.random() * 100, sum = 0, selected = 10;
  for (let c of CHANCES) {
    sum += c.w;
    if (rand <= sum) { selected = c.val; break; }
  }

  const btnCs = document.getElementById('btn-cs'); // FIX
  const isEn = btnCs ? !btnCs.classList.contains('active') : false;

  const winPrefix = isEn
    ? (t.en.gameWonText || "You won a discount of")
    : (t.cs.gameWonText || "Vyhrál jsi slevu");

  document.getElementById('reward-amount').innerText =
    `${winPrefix} ${selected}%`;

  const code = `27SUN-${selected}-${Math.random().toString(36).substring(2,6).toUpperCase()}`;
  document.getElementById('promo-code').innerText = code;

  setTimeout(() => {
    const rd = document.getElementById('reward-display');
    if (rd) rd.style.display = 'block'; // FIX
  }, 600);
}

function copyPromo() {
  const codeEl = document.getElementById('promo-code');
  if (!codeEl) return; // FIX

  navigator.clipboard.writeText(codeEl.innerText);

  const btn = document.getElementById('btn-copy');
  if (!btn) return; // FIX

  const isEn = !document.getElementById('btn-cs')?.classList.contains('active');
  btn.innerText = isEn ? 'Copied!' : 'OK!';
  setTimeout(() => btn.innerText = 'Copy', 2000);
}

/* INITIALIZATION */
document.addEventListener('DOMContentLoaded', () => {
  setLang('cs');

  const track = document.getElementById('chatTrack');
  track.innerHTML += track.innerHTML;

  document.getElementById("my-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const status = document.getElementById("my-form-status");
    const isEn = !document.getElementById('btn-cs').classList.contains('active');

    fetch(e.target.action, {
      method: 'POST',
      body: new FormData(e.target),
      headers: {'Accept': 'application/json'}
    }).then(res => {
      status.innerHTML = res.ok ? (isEn ? t.en.fOk : t.cs.fOk) : (isEn ? t.en.fErr : t.cs.fErr);
      if (res.ok) e.target.reset();
    });
  });
});
</script>